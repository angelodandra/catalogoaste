import { NextResponse } from "next/server";
import { supabaseServer } from "@/lib/supabaseServer";
import PDFDocument from "pdfkit";

export const runtime = "nodejs";

async function fetchAsBuffer(url: string) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Fetch fallito: ${url}`);
  const ab = await res.arrayBuffer();
  return Buffer.from(ab);
}

function pdfToBuffer(doc: any) {
  return new Promise<Buffer>((resolve, reject) => {
    const chunks: Buffer[] = [];
    doc.on("data", (c) => chunks.push(Buffer.isBuffer(c) ? c : Buffer.from(c)));
    doc.on("end", () => resolve(Buffer.concat(chunks)));
    doc.on("error", reject);
    doc.end();
  });
}

function safeStr(v: any) {
  return (v ?? "").toString();
}

function nowIT() {
  return new Date().toLocaleString("it-IT");
}

function eur(n: number | null | undefined) {
  if (n === null || n === undefined) return "—";
  const v = Number(n);
  if (!Number.isFinite(v)) return "—";
  return `€ ${v.toFixed(2)}`;
}

export async function GET(req: Request) {
  try {
    const url = new URL(req.url);
    const orderId = safeStr(url.searchParams.get("orderId")).trim();
    if (!orderId) return new NextResponse("orderId mancante", { status: 400 });

    const supabase = supabaseServer();

    const { data: order, error: oErr } = await supabase
      .from("orders")
      .select("id,catalog_id,customer_name,customer_phone,created_at")
      .eq("id", orderId)
      .single();
    if (oErr) throw oErr;

    const { data: items, error: iErr } = await supabase
      .from("order_items")
      .select("qty, products(id, box_number, image_path, price_eur)")
      .eq("order_id", orderId);
    if (iErr) throw iErr;

    const phone = safeStr(order.customer_phone).trim();

    let company = "";
    try {
      const { data: cust } = await supabase
        .from("customers")
        .select("company")
        .eq("phone", phone)
        .maybeSingle();
      company = safeStr(cust?.company).trim();
    } catch {}

    const base = process.env.NEXT_PUBLIC_SUPABASE_URL || "";
    const appBase = process.env.APP_BASE_URL || "http://127.0.0.1:3000";
    const logoUrl = `${appBase}/logo.jpg`;

    const doc = new PDFDocument({ size: "A4", margin: 36 });

    const pageW = doc.page.width;
    const left = doc.page.margins.left;
    const right = doc.page.margins.right;
    const usableW = pageW - left - right;

    const startY = 30;

    try {
      const logoBuf = await fetchAsBuffer(logoUrl);
      doc.image(logoBuf, (pageW - 160) / 2, startY, { width: 160 });
    } catch {
      doc.fontSize(18).font("Helvetica-Bold").text("Preparazione Ordine", { align: "center" });
    }

    doc.moveDown(3);

    doc.font("Helvetica-Bold").fontSize(16).text("Preparazione merce", { align: "center" });
    doc.moveDown(0.5);

    doc.font("Helvetica").fontSize(10);
    doc.text(`Data stampa: ${nowIT()}`);
    doc.moveDown(0.2);
    doc.font("Helvetica-Bold").fontSize(18).text(`${safeStr(order.customer_name)}${company ? ` (${company})` : ""}`, { align: "center" });
    doc.font("Helvetica").fontSize(11).text(`Creato il: ${new Date(order.created_at).toLocaleString("it-IT")}`, { align: "center" });
    doc.moveDown(0.8);

    doc.moveTo(left, doc.y).lineTo(left + usableW, doc.y).strokeColor("#cccccc").stroke();
    doc.moveDown(0.8);

    doc.font("Helvetica-Bold").fontSize(12).text("Casse da preparare", { align: "left" });
    doc.moveDown(0.5);

    const rows = (items || []).map((it: any) => {
      const p = it.products;
      return {
        qty: Number(it.qty ?? 1),
        box: safeStr(p?.box_number ?? "?"),
        image_path: safeStr(p?.image_path ?? ""),
        price: p?.price_eur ?? null,
      };
    });

    rows.sort((a, b) => Number(a.box) - Number(b.box));

    const lineH = 86;
    const thumb = 70;
    const checkboxSize = 14;

    let total = 0;

    for (const r of rows) {
      if (doc.y + lineH > doc.page.height - doc.page.margins.bottom - 20) {
        doc.addPage();
      }

      const y = doc.y;

      doc.rect(left, y + 6, checkboxSize, checkboxSize).strokeColor("#000000").stroke();

      const imgX = left + 26;
      const imgY = y;
      const imgUrl = r.image_path ? `${base}/storage/v1/object/public/catalog-images/${r.image_path}` : "";

      if (imgUrl) {
        try {
          const imgBuf = await fetchAsBuffer(imgUrl);
          doc.image(imgBuf, imgX, imgY, { width: thumb, height: thumb, fit: [thumb, thumb] });
        } catch {
          doc.fontSize(9).fillColor("gray").text("foto\nn/d", imgX + 18, imgY + 25, { align: "center" });
          doc.fillColor("black");
        }
      } else {
        doc.fontSize(9).fillColor("gray").text("foto\nmancante", imgX + 10, imgY + 25, { align: "center" });
        doc.fillColor("black");
      }

      const xText = imgX + thumb + 14;

      doc.font("Helvetica-Bold").fontSize(14).text(`Cassa ${r.box}`, xText, y + 6);

      doc.font("Helvetica").fontSize(10).fillColor("gray");
      doc.text(`Quantità: ${r.qty}`, xText, y + 30);

      const price = r.price === null || r.price === undefined ? null : Number(r.price);
      const subtotal = price !== null && Number.isFinite(price) ? price * r.qty : null;
      doc.text(`Prezzo: ${eur(price)}${subtotal !== null ? `  |  Subtotale: ${eur(subtotal)}` : ""}`, xText, y + 46);
      doc.fillColor("black");

      if (subtotal !== null) total += subtotal;

      doc.strokeColor("#e5e5e5").lineWidth(1);
      doc.moveTo(left, y + lineH).lineTo(left + usableW, y + lineH).stroke();
      doc.strokeColor("#000000").lineWidth(1);

      doc.y = y + lineH + 6;
    }

    doc.moveDown(0.5);
    doc.font("Helvetica-Bold").fontSize(12).text(`Totale (stimato): ${eur(total)}`, { align: "right" });
    doc.moveDown(0.2);
    doc.font("Helvetica").fontSize(9).fillColor("gray").text("Spunte: usa la casella a sinistra per segnare la cassa preparata.", {
      align: "center",
    });
    doc.fillColor("black");

    const pdfBuffer = await pdfToBuffer(doc);

    return new NextResponse(pdfBuffer, {
      headers: {
        "Content-Type": "application/pdf",
        "Content-Disposition": `inline; filename="prep-.pdf"`,
        "Cache-Control": "no-store",
      },
    });
  } catch (e: any) {
    return NextResponse.json({ ok: false, error: e?.message ?? "Errore server" }, { status: 500 });
  }
}
